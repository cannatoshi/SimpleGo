# SimpleX Protocol Analysis - Part 7: Session 10
# Reply Queue Three-Layer Decryption Analysis

**Document Version:** v24  
**Date:** 2026-01-28 Session 10C  
**Status:** Reply Queue Server-Level WORKING, Per-Queue DH BLOCKED  
**Previous:** Part 6 - Session 9 (Reply Queue HSalsa20 fix)

---

## 206. Session 10C Overview (2026-01-28)

### 206.1 Session Goal

Analysis and implementation of message decryption on the **Reply Queue** - the queue we create to receive messages from the peer (SimpleX App).

### 206.2 Context

| Component | Status |
|-----------|--------|
| Contact Queue Decrypt | WORKING fully |
| Reply Queue Server-Level | WORKING |
| Reply Queue Per-Queue DH | FAILED |
| Reply Queue Double Ratchet | Blocked by Layer 2 |

---

## 207. Reply Queue Encryption Architecture (2026-01-28)

### 207.1 Hypothetical Three-Layer Structure

Based on Contact Queue analysis, the following structure was assumed:

```
+-------------------------------------------------------------+
|                    MSG from Server                          |
+-------------------------------------------------------------+
|  Layer 1: Server-Level XSalsa20-Poly1305                    |
|           Key: shared_secret (srv_dh_public + rcv_dh_private)|
|           Nonce: msgId (24 bytes)                           |
+-------------------------------------------------------------+
|  Layer 2: Per-Queue DH (NaCl crypto_box)                    |
|           Key: ??? (peer_ephemeral_pub + rcv_dh_private?)   |
|           Nonce: In message? msgId?                         |
+-------------------------------------------------------------+
|  Layer 3: Double Ratchet (AES-GCM)                          |
|           Key: Chain key derived                            |
|           IV: From chainKdf                                 |
+-------------------------------------------------------------+
```

### 207.2 Contact Queue vs Reply Queue - Difference

| Aspect | Contact Queue | Reply Queue |
|--------|---------------|-------------|
| Creator | Us | Us |
| Sender | SimpleX App | SimpleX App |
| srv_dh_public | From Server at IDS | From Server at IDS |
| rcv_dh_private | Generated by us | Generated by us |
| shared_secret | WORKING | WORKING |
| Per-Queue DH Key | srv_dh_public (!) | ??? |

**Critical Discovery:** Contact Queue uses `srv_dh_public` for Per-Queue DH, NOT the ephemeral key from the message!

---

## 208. Debug Output Analysis (2026-01-28)

### 208.1 Server-Level Decrypt SUCCESS

```
Server-level decrypt SUCCESS! (16106 bytes)
First 64 bytes after server-decrypt:
   3e 82 00 00 00 00 69 7a 0c 8d 54 20 00 04 31 2c
   30 2a 30 05 06 03 2b 65 6e 03 21 00 85 09 ab 39
   bc 57 d8 1d 99 f8 b7 27 f5 bb 6e d1 0f a9 e8 4a
   7e 40 ff 71 b0 d3 8f 0a db f3 5f 5c be 27 85 4d
```

### 208.2 Structure After Server-Decrypt

| Offset | Bytes | Meaning |
|--------|-------|---------|
| 0-1 | `3e 82` | Length prefix: 16002 |
| 2-5 | `00 00 00 00` | Unknown (Padding?) |
| 6-9 | `69 7a 0c 8d` | Timestamp |
| 10-13 | `54 20 00 04` | Unknown |
| 14-15 | `31 2c` | Version "1," (ASCII) |
| 16-59 | `30 2a 30 05...` | X25519 SPKI (44 bytes) |
| 60+ | `be 27 85 4d...` | After SPKI: Nonce? Ciphertext? |

### 208.3 Comparison Contact Queue vs Reply Queue

**Both identically structured!**

```
Contact Queue:
3e 82 00 00 00 00 69 7a 09 b5 54 20 00 04 31 2c
30 2a 30 05 06 03 2b 65 6e 03 21 00 e1 a3 53 ae
                                    ^^^^^^^^^^^^
                                    Ephemeral Key

Reply Queue:
3e 82 00 00 00 00 69 7a 0c 8d 54 20 00 04 31 2c
30 2a 30 05 06 03 2b 65 6e 03 21 00 85 09 ab 39
                                    ^^^^^^^^^^^^
                                    Ephemeral Key (different)
```

---

## 209. Conducted Tests (2026-01-28)

### 209.1 Test Matrix

| Test | Key | Nonce | Result |
|------|-----|-------|--------|
| Original | peer_ephemeral + rcv_dh_private | From message (offset 60) | FAILED |
| TEST1 | peer_ephemeral + rcv_dh_private | msgId | FAILED |
| TEST2 | srv_dh_public + rcv_dh_private | msgId | FAILED |
| TEST3 | peer_ephemeral (raw) | msgId | FAILED |
| shared_secret | shared_secret (direct) | From message | FAILED |

### 209.2 Test Code

```c
// TEST 1: peer_dh + msgId nonce
uint8_t msg_nonce[24];
memset(msg_nonce, 0, 24);
memcpy(msg_nonce, msg_id, msgIdLen);
crypto_box_beforenm(test_dh, peer_pub, our_queue.rcv_dh_private);
crypto_box_open_easy_afternm(test_plain, &server_plain[data_offset], 
                              data_len, msg_nonce, test_dh);
// RESULT: FAILED

// TEST 2: srv_dh_public + msgId nonce  
crypto_box_beforenm(srv_dh, our_queue.srv_dh_public, our_queue.rcv_dh_private);
crypto_box_open_easy_afternm(test_plain, &server_plain[data_offset],
                              data_len, msg_nonce, srv_dh);
// RESULT: FAILED

// TEST 3: Direct on raw (no server decrypt)
// RESULT: No SPKI in raw data (confirms server decrypt is correct)
```

### 209.3 Test Conclusion

**ALL key combinations fail!** This indicates that either:

1. The structure is different than assumed
2. There is NO second crypto_box layer
3. The X25519 SPKI is only metadata, not the decryption key

---

## 210. New Hypothesis: No Per-Queue DH Layer? (2026-01-28)

### 210.1 Theory

Possibly the Reply Queue has **NO second crypto_box layer**!

The X25519 SPKI at offset 16 could be:
- Only metadata (sender identification)
- Used for a different function
- Part of the Double Ratchet header

### 210.2 Alternative Structure

```
+-------------------------------------------------------------+
|  Layer 1: Server-Level Decrypt                              |
|           -> Decrypted with shared_secret, nonce=msgId      |
+-------------------------------------------------------------+
|  NO Layer 2!                                                |
+-------------------------------------------------------------+
|  Layer 2 (direct): Double Ratchet (EncRatchetMessage)       |
|           -> Starts at offset 60 (after SPKI)               |
+-------------------------------------------------------------+
```

### 210.3 Problem with this Theory

Double Ratchet Decrypt also fails:
```
Decrypting incoming message (16122 bytes)...
   emHeader length: 189
Invalid emHeader length: 189
```

The emHeader length (189) is unrealistic - should be ~123-127.

---

## 211. Questions for Developers (2026-01-28)

### 211.1 Precise Technical Question

```
For Reply Queue decryption:

After server-level decrypt (using shared_secret derived from 
srv_dh_public + rcv_dh_private, with msgId as nonce), I see 
an X25519 SPKI at offset 16 in the decrypted data.

When I try to decrypt the data after SPKI using 
`crypto_box_beforenm(peer_ephemeral_pub, our_rcv_dh_private)`, 
it fails.

Questions:
1. Is there a second per-queue crypto_box layer for Reply Queue?
2. If yes, which key should be used? (peer_ephemeral_pub, srv_dh_public, or other?)
3. If no, does Double Ratchet data start directly after SPKI?
```

### 211.2 Context for the Question

- Server accepts our messages (OK response)
- App shows "error agent A_CRYPTO" 
- Contact Queue works fully
- Reply Queue Server-Level works
- Reply Queue Per-Queue fails with ALL key combinations

---

## 212. Key Structure Documentation (2026-01-28)

### 212.1 our_queue_t Structure

```c
typedef struct {
    bool valid;
    
    // Queue IDs
    uint8_t rcv_id[24];
    int rcv_id_len;
    uint8_t snd_id[24];
    int snd_id_len;
    
    // Server's DH key (from IDS response)
    uint8_t srv_dh_public[32];
    
    // Our DH keypair
    uint8_t rcv_dh_public[32];
    uint8_t rcv_dh_private[32];
    
    // Precomputed shared secret
    // = crypto_box_beforenm(srv_dh_public, rcv_dh_private)
    uint8_t shared_secret[32];
    
    // Auth keypair
    uint8_t rcv_auth_public[32];
    uint8_t rcv_auth_secret[64];
} our_queue_t;
```

### 212.2 AgentConnInfoReply (what we send)

```
Tag: 'D' (0x44)
+-- smpQueues count: 01 (Word16 BE = 00 01)
+-- SMPQueueInfo:
|   +-- version: 04 (1 byte)
|   +-- server: "smp1.simplexonflux.com"
|   +-- port: "5223"
|   +-- srvKeyHash: c505bfb9... (32 bytes)
|   +-- sndId: 139178f4... (24 bytes)
|   +-- rcv_dh_public: 74dc8bc2... (X25519 SPKI, 44 bytes)
+-- connInfo: {"v":"1-16","event":"x.info",...}
```

The app receives our `rcv_dh_public` and should use it for encryption...

---

## 213. Updated Bug Status (2026-01-28 Session 10C)

| Bug | Status | Session | Solution |
|-----|--------|---------|----------|
| BUG-001 to BUG-012 | FIXED | S1-S6 | Various fixes |
| BUG-013 | FIXED | S8 | chainKdf IV order |
| BUG-014 | FIXED | S8 | Payload AAD prefix |
| BUG-015 | FIXED | S9 | HSalsa20 key derivation |
| BUG-016 | FIXED | S9 | A_CRYPTO (was header issue) |
| **BUG-017** | **ACTIVE** | **S10C** | **Reply Queue Per-Queue DH - All keys fail!** |

---

## 214. Extended Changelog (2026-01-28 Session 10C)

| Date | Change |
|------|--------|
| 2026-01-28 S10C | **Reply Queue Server-Level Decrypt works!** |
| 2026-01-28 S10C | **Structure after Decrypt analyzed** - X25519 SPKI at offset 16 |
| 2026-01-28 S10C | **Contact vs Reply Queue comparison** - Identical structure! |
| 2026-01-28 S10C | **5 test combinations conducted** - All fail |
| 2026-01-28 S10C | **New hypothesis** - No second crypto_box layer? |
| 2026-01-28 S10C | **Technical question formulated** for SimpleX developers |
| 2026-01-28 S10C | Documentation v24 created |

---

## 215. Open Questions (2026-01-28 Session 10C)

| # | Question | Priority |
|---|----------|----------|
| 1 | Which key for Reply Queue Per-Queue DH? | CRITICAL |
| 2 | Is there even a Per-Queue layer for Reply Queue? | CRITICAL |
| 3 | Difference between Contact Queue and Reply Queue Encryption? | HIGH |
| 4 | Is the X25519 SPKI in the message only metadata? | MEDIUM |
| 5 | Why does Double Ratchet fail with emHeader length 189? | HIGH |

---

## 216. Next Steps (2026-01-28 Session 10C)

```
RECOMMENDATION: ASK DEVELOPERS!
===============================================================

We have tested ALL sensible key combinations:
- peer_ephemeral_pub + rcv_dh_private + msgId nonce
- srv_dh_public + rcv_dh_private + msgId nonce
- shared_secret (direct) + message nonce
- Direct on raw data (without Server-Decrypt)

NEXT STEP:
-> Ask precise technical question to Evgeny/SimpleX Team
-> Question is formulated above in section 211

ALTERNATIVE (if no response):
1. Analyze Haskell source code of the app (receiveAgentMessage)
2. Wireshark traffic analysis with working app
3. Compare bytes the app sends vs what we receive

===============================================================
```

---

## 217. SimpleGo Version Update (2026-01-28 Session 10C)

```
SimpleGo v0.1.17-alpha - Reply Queue Decryption Analysis
===============================================================

Session 10C Progress:
- Reply Queue created and subscribed
- Server-Level Decrypt works (shared_secret + msgId)
- Structure after Decrypt analyzed (SPKI at offset 16)
- Per-Queue DH Decrypt fails with ALL keys
- Technical question for developers formulated

Tested Key Combinations:
- peer_ephemeral + rcv_dh_private + msgId
- srv_dh_public + rcv_dh_private + msgId
- shared_secret + message_nonce
- Direct on raw data

Verified:
- Contact Queue: Full 3-Layer Decryption
- Reply Queue: Server-Level works
- Reply Queue: Per-Queue DH blocked

STATUS:
- DEVELOPER QUESTION REQUIRED!

===============================================================
```

---

**DOCUMENT CREATED: 2026-01-28 Session 10C v24**  
**Reply Queue Server-Level: WORKING**  
**Reply Queue Per-Queue DH: ALL TESTS FAIL**  
**Next: Developer Question Required!**
